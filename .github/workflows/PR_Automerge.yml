name: Auto Merge After 2 Approvals

on:
  pull_request_review:
    types: [submitted]
  check_suite:
    types: [completed]

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: write

    steps:
      - name: Check approvals and target branch
        id: approvals
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr =
              context.payload.pull_request ||
              context.payload.check_suite?.pull_requests?.[0];
              
            if (pr.base.ref !== "Development") {
              core.info(`Skipping because target branch is ${pr.base.ref}, not Development.`);
              core.setOutput("approved", "false");
              return;
            }


            const { data: reviews } = await github.rest.pulls.listReviews({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number,
            });

            const approvedUsers = new Set(
              reviews.filter(r => r.state === "APPROVED").map(r => r.user.login)
            );

            const approvals = approvedUsers.size;
            core.setOutput("approved", approvals >= 2 ? "true" : "false");

      - name: Merge to Development if approved and CI passed
        if: steps.approvals.outputs.approved == 'true'
        uses: pascalgn/automerge-action@v0.15.6
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          MERGE_METHOD: squash
          MERGE_COMMIT_MESSAGE: "Auto-merged into Development after 2 approvals"
          MERGE_DELETE_BRANCH: true
          MERGE_REQUIRED_LABELS: ""     # No labels required
          MERGE_RETRY_SLEEP: 30000      # retry every 30 s if checks still pending
          MERGE_RETRY_LIMIT: 20         # up to ~10 minutes wait for CI to finish
