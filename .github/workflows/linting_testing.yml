name: Linting and Tests CI
permissions:
  contents: write
on:
  push:
    branches:
      - Development
      - CI-UT-Pipeline
      - test-ci
  pull_request:
    branches:
      - Development

jobs:
  lint-and-test:
    name: Linting and Tests
    runs-on: ubuntu-latest

    services:
      postgres:
        image: pgvector/pgvector:pg16
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: vector_db
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    strategy:
      matrix:
        python-version: [3.13, 3.14]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Wait for PostgreSQL and enable pgvector
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client
          until pg_isready -h localhost -p 5432 -U postgres; do
            echo "Waiting for PostgreSQL..."
            sleep 2
          done
          echo "PostgreSQL is ready!"
          PGPASSWORD=postgres psql -h localhost -U postgres -d vector_db -c "CREATE EXTENSION IF NOT EXISTS vector;"
          echo "pgvector extension enabled!"
      
      - name: Install libclang system library
        run: |
          sudo apt-get update
          sudo apt-get install -y libclang-dev llvm


      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install flake8 pytest pytest-asyncio httpx mypy black isort bandit pip-audit pillow pytesseract

      - name: Install Tesseract OCR
        run: |
          sudo apt-get update
          sudo apt-get install -y tesseract-ocr
          which tesseract
          tesseract --version
          echo "TESSERACT PATH:"
          ls /usr/bin/tesseract || true
          echo "TESSERACT PATH FOUND AND ADDED TO ENV"
          echo "TESSDATA_PREFIX=/usr/share/tesseract-ocr/5/tessdata" >> $GITHUB_ENV
          echo "/usr/bin" >> $GITHUB_PATH
      
      - name: Install Poppler (for PDF OCR)
        run: |
          sudo apt-get update
          sudo apt-get install -y poppler-utils
          which pdftoppm
          pdftoppm -v || true

      - name: Auto-format and Lint
        if: matrix.python-version == '3.14'
        continue-on-error: true
        run: |
          echo "Running auto-format and lint checks"
          black src --line-length 130
          isort src
          flake8 src --max-line-length=130 --exclude=__pycache__,.pytest_cache --exit-zero
          mypy src || true
          bandit -r src || true
          pip-audit || true

      - name: Commit and push formatting fixes
        if: matrix.python-version == '3.14' && github.event_name == 'push' && github.actor != 'dependabot[bot]'
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add .
          if git diff --cached --quiet; then
            echo "No formatting changes to commit."
          else
            git commit -m "chore(ci): auto-format code (via black/isort)"
            git push
          fi

      - name: Run Unit Tests
        run: |
          echo "Running backend unit tests"
          export PYTHONPATH=$(pwd)
          export TESSDATA_PREFIX=/usr/share/tesseract-ocr/5/tessdata
          export PATH=$PATH:/usr/bin
          pytest src/tests/backend_test -v --disable-warnings --maxfail=1
        env:
          VECTOR_DB_URL: postgresql+psycopg://postgres:postgres@localhost:5432/vector_db

